---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  releaseName: loki
  interval: 30m
  chart:
    spec:
      chart: loki
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      version: "6.*"
      interval: 12h
  # https://github.com/grafana/loki/tree/main/production/helm/loki
  values:
    # ==========================================
    # Deployment Mode & Resources
    # ==========================================
    deploymentMode: SingleBinary
    singleBinary:
      replicas: 1
      resources:
        limits:
          cpu: 2
          memory: 4Gi
        requests:
          cpu: 1
          memory: 2Gi
    # Zero out replica counts of other deployment modes
    backend:
      replicas: 0
    read:
      replicas: 0
    write:
      replicas: 0

    minio:
      enabled: false

    # ==========================================
    # Loki's Config
    # ==========================================
    loki:
      commonConfig:
        replication_factor: 1
      ingester:
        chunk_encoding: snappy
      querier:
        # Default is 4, if you have enough memory and CPU you can increase, reduce if OOMing
        max_concurrent: 2
      # ============================================================================
      # Storage Retentaion
      # It's recommended to add a lifecycle policy on you object storage bucket.
      # to delete all the logs older than [retention_period + 1 day].
      # To assure the old logs get deleted.
      # https://grafana.com/docs/loki/latest/operations/storage/retention/
      # ============================================================================
      # Compact multiple index files in the table into a single index file per tenant per day.
      compactor:
        compaction_interval: 10m
        retention_enabled: true
        retention_delete_delay: 2h
        retention_delete_worker_count: 150
        delete_request_store: s3
      limits_config:
        reject_old_samples: true
        reject_old_samples_max_age: 168h
        max_query_lookback: 168h # 7 days
        # delete logs older than this period
        retention_period: 168h
        retention_stream:
        # keey only 1 day for dev logs
        - selector: '{namespace="dev"}'
          priority: 1
          period: 24h
        max_cache_freshness_per_query: 10m
        split_queries_by_interval: 15m
        query_timeout: 60s
        max_query_parallelism: 32
        max_concurrent_tail_requests: 10
        # ========================================================
        # OTEL related
        # https://grafana.com/docs/loki/latest/send-data/otel/
        # ========================================================
        allow_structured_metadata: true
        # otlp_config:
        #   resource_attributes:
        #     ignore_defaults: true
        #     attributes_config:
        #       - action: index_label
        #         attributes:
        #           - service.group

