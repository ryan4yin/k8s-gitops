# https://fluxcd.io/flux/components/helm/helmreleases/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics-k8s-stack
  namespace: monitoring
spec:
  install:
    crds: CreateReplace
    replace: true
  releaseName: victoriametrics
  interval: 30m
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      sourceRef:
        kind: HelmRepository
        name: victoria-metrics
        namespace: flux-system
      version: "0.50.*"
      interval: 12h
  # https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-k8s-stack
  values:
    nameOverride: vmks # avoid hitting resource name limits of 63 characters

    # -- Tenant to use for Grafana datasources and remote write, used in Cluster Version
    tenant: "0"

    # -- VictoriaMetrics Operator dependency chart configuration. More values can be found [here](https://docs.victoriametrics.com/helm/victoriametrics-operator#parameters). Also checkout [here](https://docs.victoriametrics.com/operator/configuration/#environment-variables) possible ENV variables to configure operator behaviour
    # https://github.com/VictoriaMetrics/helm-charts/blob/master/charts/victoria-metrics-operator/values.yaml
    victoria-metrics-operator:
      enabled: true
      serviceMonitor:
        enabled: true
        # -- Creates `VMServiceScrape` if `true` and `ServiceMonitor` otherwise.
        vm: true
      operator:
        # -- By default, operator converts prometheus-operator objects.
        disable_prometheus_converter: false
        # -- Compare-options and sync-options for prometheus objects converted by operator for properly use with ArgoCD
        prometheus_converter_add_argocd_ignore_annotations: true
        # Enables ownership reference for converted prometheus-operator objects, it will remove corresponding victoria-metrics objects in case of deletion prometheus one.
        enable_converter_ownership: true

    kube-state-metrics:
      enabled: true
    vmagent:
      # vmagent collects metrics from targets and sends them to a remote storage
      enabled: true
      # spec for VMAgent crd
      # https://docs.victoriametrics.com/operator/api.html#vmagentspec
      spec:
        # https://docs.victoriametrics.com/operator/api.html#vmagentremotewritespec
        remoteWrite:
        - url: https://prometheus.writefor.fun/api/v1/write
          tlsConfig:
            caFile: /data/ca-certs/ca.crt
        selectAllByDefault: true
        scrapeInterval: 20s
        externalLabels:
          # For multi-cluster setups it is useful to use "cluster" label to identify the metrics source.
          type: kubernetes
        extraArgs:
          # vmagent automatically switches to VictoriaMetrics remote write protocol when it sends data to VictoriaMetrics components
          remoteWrite.forceVMProto: "true"
          remoteWrite.vmProtoCompressLevel: "5" # -22 ~ 22, default to 0

          promscrape.streamParse: "true"
          # Do not store original labels in vmagent's memory by default. This reduces the amount of memory used by vmagent
          # but makes vmagent debugging UI less informative. See: https://docs.victoriametrics.com/vmagent/#relabel-debug
          promscrape.dropOriginalLabels: "false"
        # https://docs.victoriametrics.com/victoriametrics/relabeling/
        # NOTE: If a label from the scrape configuration (target_label) conflicts with a label from the scraped metric (scrape-time label), 
        # the original scrape-time label is renamed by adding an `exported_` prefix.
        globalScrapeMetricRelabelConfigs:
          # Drop all unused/duplicate labels to avoid excessive label cardinality.
          # This is a best practice for performance.
          - action: labeldrop
            regex: "beta_kubernetes_io_(.+)"
          - action: labeldrop
            regex: "failure_domain_(.+)"
          - action: labeldrop
            regex: "prometheus"
        volumes: &volumes
          - name: ca-certs
            secret:
              secretName: ca-certs
        volumeMounts: &volumeMounts
          - name: ca-certs
            mountPath: /data/ca-certs
            readOnly: true
        resources:
          limits:
            cpu: "1"
            memory: "1Gi"
          requests:
            cpu: "100m"
            memory: "500Mi"  
      ingress:
        enabled: false
        ingressClassName: kong

    # disable this , we use a external vmcluster instead.
    vmcluster:
      enabled: false
      # -- Full spec for VMCluster CRD. Allowed values described [here](https://docs.victoriametrics.com/operator/api#vmclusterspec)
      spec:
        # -- Data retention period. Possible units character: h(ours), d(ays), w(eeks), y(ears), if no unit character specified - month. 
        # The minimum retention period is 24h. See these [docs](https://docs.victoriametrics.com/single-server-victoriametrics/#retention)
        # enterprise edition: set different retentionPeriod based on label filter
        retentionPeriod: "30d"
        # Store N copies for every ingested sample on N distinct vmstorage nodes.
        # This guarantees that all the stored data remains available for querying if up to N-1 vmstorage nodes are unavailable.
        # https://docs.victoriametrics.com/victoriametrics/cluster-victoriametrics/#replication-and-data-safety
        replicationFactor: 1
        vmstorage:
          replicaCount: 3
          extraArgs:
            # https://docs.victoriametrics.com/victoriametrics/cluster-victoriametrics/#resource-usage-limits
            search.maxUniqueTimeseries: "1000000"
            # Allowed percent of system memory VictoriaMetrics caches may occupy
            memory.allowedPercent: 60
          storage:
            volumeClaimTemplate:
              spec:
                resources:
                  requests:
                    storage: 30Gi
          resources: {}
        vmselect:
          # -- Set this value to false to disable VMSelect
          enabled: true
          replicaCount: 3
          extraArgs:
            search.maxQueryDuration: 60s
            search.maxConcurrentRequests: 4 # default = 2 * vcpu cores
            # Allowed percent of system memory VictoriaMetrics caches may occupy
            memory.allowedPercent: 60
          resources: {}
        vminsert:
          # -- Set this value to false to disable VMInsert
          enabled: true
          replicaCount: 3
          extraArgs:
            maxInsertRequestSize: 32MB # default to 32MB
          resources: {}

    # ================================================================
    # Disabled components
    # ================================================================

    prometheus-node-exporter:
      # instead of deploy node-exporter as pods, we do this via nixos module.
      enabled: false

    # Since we store metrics in a remote prometheus via remote write,
    # we don't need to store & query metrics in VictoriaMetrics. so disable all components here.
    grafana:
      enabled: false
    vmalert:
      # vmalert is a Prometheus-compatible alertmanager
      enabled: false
    alertmanager:
      enabled: false
    vmsingle:
      # Single-node VictoriaMetrics for storing metrics.
      # https://docs.victoriametrics.com/faq/#which-victoriametrics-type-is-recommended-for-use-in-production---single-node-or-cluster
      # vmsingle = vmcluster(vmselect + vmstorage + vminsert)
      enabled: false
